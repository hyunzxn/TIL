# AWS VPC Security

&nbsp;

# 1. 들어가며

AWS VPC를 사용하며 항상 빠지지 않는 것이 있습니다. 바로 보안그룹(Security Group) 입니다. 이름에서 알 수 있듯이 보안그룹은 VPC 내 존재하는 자원의 보안을 책임지는 역할을 수행합니다. 이와 유사하게 네트워크 ACL이라는 것도 있는데요. 네트워크 ACL 역시 보안의 역할을 수행합니다. 다만 약간의 차이는 있습니다. 보안그룹은 서브넷 안에 있는 IT 자원을 보호합니다. 이와 달리 네트워크 ACL은 서브넷 자체를 보호합니다. 

이번 포스팅에서는 보안그룹과 네트워크 ACL의 특징, 작동원리 등에 대해서 정리해보고자 합니다.

&nbsp;

# 2. 알아둬야 할 사전 지식

### 2.1 네트워크 접근제어

네트워크 접근제어는 IP 주소와 Port 번호가 모두 허용 기준에 일치할 때만 접근을 허용하는 방식으로 진행합니다. 예를 들어 네트워크 허용 정책 테이블에 `1.1.1.0/24 + TCP 80` 이렇게 IP 주소와 프로토콜 & 포트번호가 있다고 한다면 여기에 해당하는 IP주소와 프로토콜과 포트번호의 네트워크 트래픽만 접근이 허용되는 것이죠.

&nbsp;

<예시>

`1.1.2.0/24 + TCP 80` → 차단: IP 주소 불일치

`1.1.1.0/24 + TCP 22` → 차단: 포트번호 불일치

`1.1.1.0/24 + TCP 80` → 허용

&nbsp;

#### 2.2 트래픽 흐름의 방향성

일반적인 네트워크 환경은 양방향으로 `트래픽`을 주고 받는 환경입니다. 따라서 접근 제어의 대상은 `트래픽`이 됩니다. 트래픽을 주고 받는 상황을 도식으로 표현하면 다음과 같습니다.

<img src="https://github.com/hyunzxn/TIL/assets/100478841/bb5859e3-ae9e-49e2-a022-ba2814a75c13" height=300/>



Client가 요청을 보내고 Server가 요청을 받는 상황을 가정하겠습니다. 

[트래픽 출발 시점]

- 출발지 IP: 1.1.1.1
- 출발지 포트: 52345
- 목적지 IP: 2.2.2.2
- 목적지 포트: 80

[트래픽 응답 시점]

- 출발지 IP: 2.2.2.2
- 출발지 포트: 80
- 목적지 IP: 1.1.1.1
- 목적지 포트: 52345

&nbsp;

동일한 트래픽을 클라이언트 ↔︎ 서버가 주고 받는 것이기 때문에 먼저 요청을 보내는 시점과 요청에 대한 응답을 보내는 시점일 때 출발지 정보와 목적지 정보가 서로 바뀌는 것을 확인할 수 있습니다.

트래픽을 서버에 먼저 보내는 시점에 접근제어를 거치는 것을 `인바운드`라 하고 반대로 서버에서 클라이언트에 응답을 보낼 때 접근제어를 거치는 것을 `아웃바운드`라 합니다. 그래서 접근 제어를 할 때에는 인바운드 규칙, 아웃바운드 규칙 두 가지를 설정합니다. 각각의 상황에 어떤 IP, 포트, 프로토콜 등을 허용해줄지를 별도로 설정하는 것이 가능하다는 의미입니다.

&nbsp;

> **포트 번호**
>
> 포트번호는 16비트 구조로 2¹⁶인 65,356개를 사용할 수 있습니다. 그런데 일반적으로 잘 알려진 포트와 임시 포트번호로 구분을 하고 있습니다.
>
> 1. 잘 알려진 포트 번호: 0 ~ 1,023
>
> 2. 임시 포트 번호
>
>    등록된 포트번호: 1,024 ~ 49,151
>
>    동적 포트번호: 49,152 ~ 65,535
>
> 임시 포트 번호는 OS별로 범위가 다르기 때문에 확인이 필요합니다. 

&nbsp;

# 3. 보안그룹(Security Group)과 네트워크 ACL

### 3.1 보안그룹(Security Group)

보안그룹은 서브넷 안에 생성된 IT 자원의 트래픽 접근 제어를 막는 역할을 수행합니다. 보안 그룹은 **Stateful** 특성을 지니고 있습니다.

> **Stateful 특성**
>
> 인바운드 규칙에서 허용된 트래픽에 대해서는 아웃바운드 규칙에서 별도로 트래픽 허용 규칙을 명시해놓지 않아도 해당 트래픽은 통신에 성공하게 하도록 상태를 유지하는 특성

앞서 네트워크 통신은 트래픽의 양방향성 흐름이라고 설명을 드렸는데요. 원래대로라면 인바운드 규칙과 아웃바운드 규칙에서 모두 허용이 되어야 트래픽의 흐름이 정상적으로 흘러가게 됩니다. 그런데 보안그룹은 인바운드 규칙에서 허용된 트래픽은 굳이 아웃바운드 규칙에서 또 허용을 해주지 않아도 통과되게끔 트래픽의 상태를 유지하고 있는 것입니다. 

일반적으로 보안그룹의 정책 테이블에는 허용할 트래픽에 관한 정보만 나열합니다. 정책테이블에 있는 모든 정책을 통과하지 못 하게 될 경우 해당 트래픽은 자동적으로 거부됩니다.

&nbsp;

### 3.2 네트워크 ACL

네트워크 ACL은 VPC 안에 생성된 서브넷 자체를 보호하는 역할을 수행합니다. 네트워크 ACL은 보안그룹과 달리 **Stateless** 특성을 지니고 있습니다.

> **Stateless 특성**
>
> 인바운드 규칙에서 허용된 트래픽이라고 하더라도 아웃바운드 규칙에서 한 번 더 허용을 해줬을 때만 트래픽의 통신이 성공되게끔 상태를 유지하지 않는 특성

Stateless 특성은 보안그룹의 Stateful 특성과 정반대입니다. 인바운드 규칙에서 허용된 트래픽이라고 해도 아웃바운드 규칙에서 허용이 되어있지 않다면 트래픽이 나갈 수 없게 되고 따라서 통신이 정상적으로 수행되지 않게 됩니다.

네트워크 ACL의 정책테이블에는 트래픽에 대한 허용/거부 여부를 직접 설정할 수 있습니다. 그리고 정책 테이블의 마지막 정책은 모든 트래픽에 대해서 모두 거부하는 정책을 넣는 것이 컨벤션입니다. (이 부분은 네트워크 ACL을 설정하게 되면 기본적으로 모든 트래픽에 대해서 거부하는 정책이 디폴트로 들어가 있는 것을 봄으로써 확인할 수 있습니다.)

&nbsp;

# 4. 마치며

네트워크 ACL은 Stateless의 특성 상 설정할 것이 많고 보안그룹에 비해 복잡하기 때문에 많이 사용하지는 않습니다. 그러나 보안그룹은 AWS에서 자원을 생성할 때 거의 필수적으로 넣는 것 중 하나입니다. 보안그룹에 대해서 제대로 이해하지 못 하면 자원을 생성했는데 통신이 원활하게 되지 않는 경험을 할 수 있습니다. 그러므로 어떤 트래픽을 허용할지 프로토콜과 IP 주소, 포트번호 등을 잘 확인해서 설정하는 것이 중요합니다.