# 들어가며

AWS 에서 EC2를 만들면 기본적으로 http 통신만 가능합니다. 그렇지만 보안적으로 안전한 서비스를 구성하기 위해서 요새는 다들 https 를 사용합니다. 이번 글에서는 EC2에 https를 적용하는 방법에 대해서 정리해보고자 합니다. EC2를 생성했다는 전제 하에 진행하는 점 참고 바랍니다.

&nbsp;

# 전체적인 흐름

자세하게 살펴보기 앞서 전체적인 흐름을 알아보고자 합니다.

1. EC2에 DNS 적용하기
2. SSL 인증서 발급받기
3. Target Group 생성

4. 로드밸런서 세팅
5. Route53 호스트 영역에 A 레코드 생성
6. 로드밸런서에 규칙 추가

&nbsp;

# 1. EC2에 DNS 적용하기

저는 바로 `AWS Route53` 에서 도메인을 구매하였습니다. `AWS Route53` 에서 도메인을 구매하면 자동으로 호스팅 영역까지 생성해준다는 장점이 있습니다. 이미 구매한 도메인이 있는 분들은 `AWS Route53` 에 호스팅 영역을 어떻게 구성하시는지 검색해보시고 적용해보시면 될 것 같습니다.

# 2. SSL 인증서 발급받기

저는 `AWS Certificate Manager` 서비스에서 발급 받았습니다. 단계는 다음과 같습니다.

1. 인증서 요청 버튼 클릭
2. 퍼블릭 인증서 요청
3. 1번에서 만든 도메인 이름을 넣어줍니다.
   1. 만약 서브 도메인까지 다 포함되는 인증서를 만들어 주려면 **반드시** 와일드 카드를 넣어줘야 합니다. Ex) `*.your-domain.com`
   2. 와일드 카드 없이 도메인 이름만 넣게 되면 추후에 서브 도메인이 추가된 도메인에 대해서는 HTTPS 적용이 되지 않습니다. (이걸로 엄청 애를 먹었습니다.)
4. 검증 방법은 DNS 검증을 선택해줍니다.
5. 키 알고리즘은 기본값 사용하시면 됩니다.
6. 인증서가 생성되고 나면 `Route53` 에서 레코드 생성 버튼을 눌러서 CNAME 을 생성해줍니다.
7. 시간이 지나면 인증서 상태가 발급됨으로 바뀌고 인증서를 사용할 수 있게 됩니다.

# 3. Target Group 생성

Target Group을 생성하기 앞서 EC2의 보안그룹에 자신의 서버가 사용하는 포트 번호, HTTP, HTTPS 프로토콜 등이 모두 열려있는지 확인을 해야합니다. 만약에 열려있지 않다면 모든 IP에 대해 허용을 해줘야 합니다.

1. EC2 대상 그룹 탭에 들어가서 대상 그룹 생성을 눌러줍니다.
2. 대상 유형 선택은 인스턴스를 선택해줍니다.
3. 이름을 적당히 입력해줍니다.
4. 프로토콜은 HTTP 포트는 서버에서 사용할 포트번호(저의 경우는 스프링을 사용하고 있어서 8080 을 입력해줬습니다.)
5. VPC는 EC2가 위치한 VPC를 선택해줍니다.
6. 상태검사 부분은 헬스체크라 하여 대상그룹에 속한 AWS 자원이 정상적인 상태인지를 주기적으로 확인하는 경로와 응답코드를 설정하는 부분입니다. 현재 서버 상황에 맞게 설정해주면 됩니다. (저는 별도로 "/health" 라는 경로를 만들고 GET 요청을 보내면 "healthy!" 를 리턴하는 헬스체크용 API를 생성했습니다.)
7. 다음을 누르고 사용할 인스턴스를 클릭한 후에 포트번호를 4번에서 입력한 포트번호를 입력한 후에 아래에 포함시킵니다.

# 4. 로드밸런서 세팅

이제 거의 다 왔습니다. 여기가 살짝 복잡합니다. 

1. EC2 로드밸런서 탭에 들어가서 생성을 눌러줍니다.
2. Application Load Balancer를 선택해줍니다.
3. 이름을 입력해줍니다.
4. EC2가 위치한 VPC를 선택하고 가용영역을 2개 이상 선택해야 합니다. 이 때 반드시 EC2가 있는 가용영역과 서브넷이 포함되어야 합니다. 또한 모든 서브넷이 퍼블릭 서브넷이어야 합니다.
   1. 저는 처음에 EC2가 있는 퍼블릭 서브넷과 그냥 프라이빗 서브넷 아무거나 넣었다가 어쩔 때는 요청이 엄청 빨리 응답되고 어쩔 때는 아예 응답이 안 되는 지옥같은 복불복을 경험했습니다..
5. 보안그룹은 EC2를 생성할 때 사용한 보안그룹을 사용합니다.
6. 리스너를 추가해줘야 합니다. 리스너는 이제 로드밸런서가 받아들이는 부분이라고 생각하면 좋습니다. 
   1. 저는 HTTP/80, HTTPS/443, HTTP:8080 이렇게 세 개를 생성했습니다.
   2. 리스너의 대상 그룹은 3번에서 만들어 둔 대상그룹을 넣어줍니다.
7. 내려서 Security Policy 부분에서 2번에서 만든 인증서를 넣어줍니다.

# 5. Route53에 A 레코드 생성

1. Route53 호스팅 영역에서 레코드 생성을 눌러줍니다.
2. 서브 도메인을 넣을거면 추가해주시고 아니라면 그냥 둡니다.
3. 레코드 유형은 A 를 선택해줍니다.
4. `별칭` 토글을 켜줍니다.
5. 엔드포인트는 Application Loadbalancer를 선택해줍니다.
6. 리전은 로드밸런서가 있는 리전을 선택해줍니다.
7. 라우팅 정책은 단순 라우팅 정책을 선택해줍니다.

# 6. 로드밸런서 규칙 추가

이 부분은 80 포트나 8080 포트로 들어오는 요청을 443 포트로 리다이렉션 해주기 위한 규칙입니다. 이렇게 하면 80 또는 8080 포트를 직접 입력해주지 않아도 바로 요청이 가능합니다.

1. 생성한 로드밸런서에 들어가줍니다.
2. 리스너 및 규칙을 선택해줍니다. 아까 로드밸런서를 생성할 때 추가한 리스너들이 보일 것입니다.
3. 먼저 HTTP 80 포트부터 진행하겠습니다. 
   1. 규칙을 눌러줍니다.
   2. 규칙 추가 버튼을 눌러줍니다.
   3. 이름 및 태그를 입력해줍니다. (필수는 아닙니다.)
   4. 조건 추가 버튼을 눌러줍니다.
      1. 조건 선택에서 호스트 헤더를 선택해줍니다.
      2. 호스트 헤더를 `*.your-domain.com` 을 입력해줍니다.
      3. 다음을 눌러줍니다.
      4. 라우팅 액션을 URL로 리디렉션을 선택해줍니다.
      5. 프로토콜은 HTTPS, 포트는 443을 선택해줍니다.
      6. 상태코드는 301 그대로 유지합니다.
      7. 규칙 우선순위를 입력해줍니다.
4. 8080 포트 리스너에 대해서도 동일하게 진행해줍니다.

&nbsp;

# 마치며

저는 SSL 인증서를 만들 때 서브 도메인을 고려하지 못 하고 와일드 카드를 추가하지 않아서 꽤나 애를 먹었습니다. 처음에는 무척 어렵게 느껴졌지만 익숙해지니 할 만 해 진 것 같습니다. 포기하지말고 다들 도전해보세요!